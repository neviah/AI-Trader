"use strict";(()=>{var t={};t.id=6472,t.ids=[6472],t.modules={517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2081:t=>{t.exports=require("child_process")},6113:t=>{t.exports=require("crypto")},2361:t=>{t.exports=require("events")},3685:t=>{t.exports=require("http")},5687:t=>{t.exports=require("https")},3837:t=>{t.exports=require("util")},4834:(t,e,a)=>{a.r(e),a.d(e,{headerHooks:()=>w,originalPathname:()=>h,requestAsyncStorage:()=>d,routeModule:()=>u,serverHooks:()=>p,staticGenerationAsyncStorage:()=>l,staticGenerationBailout:()=>m});var r={};a.r(r),a.d(r,{GET:()=>GET,POST:()=>POST});var n=a(884),s=a(6132),i=a(5798),o=a(8385);let c=new o.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-10-29.clover"});async function POST(t){try{let{action:e,userId:a,...r}=await t.json();switch(e){case"connect_bank":return await connectBankAccount(a,r);case"withdraw":return await withdrawFunds(a,r);case"get_bank_accounts":return await getBankAccounts(a);default:return i.Z.json({error:"Invalid action"},{status:400})}}catch(t){return console.error("Bank API error:",t),i.Z.json({error:t.message},{status:500})}}async function connectBankAccount(t,e){try{let a;try{let t=await c.customers.list({email:e.email,limit:1});a=t.data[0]}catch(t){a=null}a||(a=await c.customers.create({email:e.email,metadata:{userId:t}}));let r=await c.setupIntents.create({customer:a.id,payment_method_types:["us_bank_account"],usage:"off_session"});return i.Z.json({success:!0,setupIntent:{client_secret:r.client_secret,id:r.id},customerId:a.id})}catch(t){throw Error(`Failed to connect bank account: ${t.message}`)}}async function withdrawFunds(t,e){try{let{amount:a,paymentMethodId:r,customerId:n,liquidationRequired:s=!0}=e;if(!a||a<1)throw Error("Invalid withdrawal amount");if(s){let e=await fetch("http://localhost:8002/liquidate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:t})});if(!e.ok)throw Error("Failed to liquidate portfolio for withdrawal");let a=await e.json();console.log("Portfolio liquidated:",a)}let o=await c.transfers.create({amount:Math.round(100*a),currency:"usd",destination:r,metadata:{userId:t,type:"withdrawal",liquidated:s.toString()}});return i.Z.json({success:!0,withdrawal:{id:o.id,amount:a,status:"pending",estimatedArrival:"3-5 business days",created:new Date().toISOString()}})}catch(t){throw Error(`Withdrawal failed: ${t.message}`)}}async function getBankAccounts(t){try{let e=await c.customers.list({limit:100}),a=e.data.find(e=>e.metadata.userId===t);if(!a)return i.Z.json({success:!0,bankAccounts:[]});let r=await c.paymentMethods.list({customer:a.id,type:"us_bank_account"}),n=r.data.map(t=>({id:t.id,bank_name:t.us_bank_account?.bank_name,last4:t.us_bank_account?.last4,account_type:t.us_bank_account?.account_type,status:"verified"}));return i.Z.json({success:!0,bankAccounts:n})}catch(t){throw Error(`Failed to get bank accounts: ${t.message}`)}}async function GET(t){try{let{searchParams:e}=new URL(t.url),a=e.get("userId");if(!a)return i.Z.json({error:"User ID required"},{status:400});let r=await c.transfers.list({limit:50,expand:["data.destination"]}),n=r.data.filter(t=>t.metadata.userId===a).map(t=>({id:t.id,amount:t.amount/100,status:"pending",created:new Date(1e3*t.created).toISOString(),estimated_arrival:null}));return i.Z.json({success:!0,withdrawals:n})}catch(t){return console.error("Error getting withdrawal history:",t),i.Z.json({error:t.message},{status:500})}}let u=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/banking/route",pathname:"/api/banking",filename:"route",bundlePath:"app/api/banking/route"},resolvedPagePath:"/workspaces/AI-Trader/frontend/app/api/banking/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:d,staticGenerationAsyncStorage:l,serverHooks:p,headerHooks:w,staticGenerationBailout:m}=u,h="/api/banking/route"}};var e=require("../../../webpack-runtime.js");e.C(t);var __webpack_exec__=t=>e(e.s=t),a=e.X(0,[1997,8385],()=>__webpack_exec__(4834));module.exports=a})();